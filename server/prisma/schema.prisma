datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==================== GOVERNMENT VERIFICATION & CYBER THREAT SOLUTION ====================
// Sierra Leone Government Information Verification & Cyber Threat Reporting System
// Last Updated: December 6, 2025

// ==================== ENUMS ====================

enum VerificationStatus {
  VERIFIED          // ✅ Confirmed true by official sources
  PARTIALLY_TRUE    // ⚠️ Contains some truth, some false
  FALSE             // ❌ Confirmed false/misinformation
  UNVERIFIED        // ❓ Cannot verify from available sources
  PENDING           // ⏳ Verification in progress
}

enum ThreatReportStatus {
  PENDING               // Initial status, awaiting review
  URGENT                // High priority, immediate attention needed
  UNDER_INVESTIGATION   // Being actively investigated
  RESOLVED              // Investigation complete, threat addressed
  CLOSED                // Case closed, no further action
}

enum ConfidenceLevel {
  HIGH      // Strong evidence from multiple official sources
  MEDIUM    // Some evidence, limited sources
  LOW       // Weak evidence or unreliable sources
  UNKNOWN   // Cannot determine confidence
}

enum ThreatType {
  ROMANCE_SCAM          // Fake relationships requesting money
  INVESTMENT_FRAUD      // Ponzi schemes, fake crypto, "get rich quick"
  IMPERSONATION         // Fake government officials, police, ministers
  PHISHING              // Fake bank messages, password theft
  MOBILE_MONEY_FRAUD    // MTN/Orange money scams
  JOB_SCAM              // Fake job offers requesting fees
  LOTTERY_PRIZE_SCAM    // Fake winnings requiring payment
  BLACKMAIL_SEXTORTION  // Threats to release private content
  IDENTITY_THEFT        // Stolen personal information misuse
  FAKE_CHARITY          // Fraudulent donation requests
  SOCIAL_MEDIA_HACK     // Account takeover and fraud
  OTHER                 // Other types of cyber threats
}

enum InformationCategory {
  GOVERNMENT_POLICY     // New laws, regulations, taxes, fees
  HEALTH                // Disease outbreaks, vaccination, medical advice
  SECURITY              // Emergency alerts, police operations, travel warnings
  FINANCIAL             // Banking regulations, currency, grants, benefits
  LEGAL                 // Court decisions, arrest warrants, legal procedures
  ADMINISTRATIVE        // Document requirements, office hours, processes
  EDUCATION             // School policies, exams, scholarships
  INFRASTRUCTURE        // Roads, electricity, water services
  SOCIAL_WELFARE        // Social programs, assistance schemes
  EMPLOYMENT            // Job opportunities, labor laws
  OTHER                 // Other categories
}

enum UserRole {
  CITIZEN               // Regular user reporting/querying
  VERIFIER              // Official who verifies information
  INVESTIGATOR          // Cyber crime investigator
  ADMIN                 // System administrator
}

// ==================== CORE MODELS ====================

// Citizens/Users of the system
model User {
  id                    Int                     @id @default(autoincrement())
  phoneE164             String                  @unique @map("phone_e164") // E.164 format: +23276123456
  name                  String?
  email                 String?
  role                  UserRole                @default(CITIZEN)
  isBlocked             Boolean                 @default(false) @map("is_blocked")
  createdAt             DateTime                @default(now()) @map("created_at")
  lastActiveAt          DateTime                @default(now()) @map("last_active_at")
  
  // Relations
  verifications         Verification[]
  threatReports         CyberThreatReport[]
  infoRequests          InformationRequest[]
  feedbacks             UserFeedback[]
  
  @@map("users")
  @@index([phoneE164])
  @@index([role])
}

// Information Verification Requests
model Verification {
  id                    Int                     @id @default(autoincrement())
  claim                 String                  @db.Text // The claim/information to verify
  category              InformationCategory
  status                VerificationStatus      @default(PENDING)
  
  // User information
  requesterPhone        String                  @map("requester_phone")
  user                  User?                   @relation(fields: [requesterPhone], references: [phoneE164])
  
  // Verification details
  requestedAt           DateTime                @default(now()) @map("requested_at")
  verifiedAt            DateTime?               @map("verified_at")
  result                String?                 @db.Text // Full verification result/explanation
  confidence            ConfidenceLevel?
  sources               Json?                   // JSON array of sources: [{name, url, date}, ...]
  verifiedBy            String?                 @map("verified_by") // Admin/analyst who verified
  
  // RAG integration
  ragResponse           String?                 @db.Text @map("rag_response") // Raw response from GenelineX RAG
  ragChatbotId          String?                 @map("rag_chatbot_id")
  ragProcessedAt        DateTime?               @map("rag_processed_at")
  
  // Analytics
  responseTimeMs        Int?                    @map("response_time_ms") // Time to get RAG response
  viewCount             Int                     @default(0) @map("view_count") // Times this verification was viewed
  shareCount            Int                     @default(0) @map("share_count") // Times this was shared
  
  // Relations
  feedbacks             UserFeedback[]
  
  @@map("verifications")
  @@index([requesterPhone])
  @@index([category])
  @@index([status])
  @@index([requestedAt])
  @@index([confidence])
}

// Cyber Threat Reports (Scams, Fraud, etc.)
model CyberThreatReport {
  id                    Int                     @id @default(autoincrement())
  referenceNumber       String                  @unique @map("reference_number") // TH-2024-00001
  threatType            ThreatType              @map("threat_type")
  description           String                  @db.Text // Detailed description from user
  
  // Threat details
  platform              String                  // Facebook, WhatsApp, SMS, Email, etc.
  amountLost            Float?                  @map("amount_lost") // In Leones (Le)
  perpetratorContact    String?                 @map("perpetrator_contact") // Phone, email, social media handle
  perpetratorName       String?                 @map("perpetrator_name")
  dateOccurred          DateTime?               @map("date_occurred")
  location              String?                 // Where the incident occurred
  
  // Priority and status
  isUrgent              Boolean                 @default(false) @map("is_urgent")
  status                ThreatReportStatus      @default(PENDING)
  
  // Reporter information
  reporterPhone         String                  @map("reporter_phone")
  user                  User?                   @relation(fields: [reporterPhone], references: [phoneE164])
  reportedAt            DateTime                @default(now()) @map("reported_at")
  
  // Evidence
  evidenceUrls          Json?                   @map("evidence_urls") // Array of evidence file URLs
  hasEvidence           Boolean                 @default(false) @map("has_evidence")
  
  // Investigation
  investigatorNotes     String?                 @db.Text @map("investigator_notes")
  assignedTo            String?                 @map("assigned_to") // Investigator ID/name
  actionTaken           String?                 @db.Text @map("action_taken")
  resolvedAt            DateTime?               @map("resolved_at")
  closedAt              DateTime?               @map("closed_at")
  
  // Pattern detection
  isRelatedToPattern    Boolean                 @default(false) @map("is_related_to_pattern")
  patternId             Int?                    @map("pattern_id")
  pattern               ThreatPattern?          @relation(fields: [patternId], references: [id])
  
  // Analytics
  impactLevel           String?                 @map("impact_level") // LOW, MEDIUM, HIGH, CRITICAL
  
  @@map("cyber_threat_reports")
  @@index([reporterPhone])
  @@index([perpetratorContact])
  @@index([status])
  @@index([threatType])
  @@index([isUrgent])
  @@index([reportedAt])
  @@index([platform])
}

// Pattern Detection for Cyber Threats (Known Scammers)
model ThreatPattern {
  id                    Int                     @id @default(autoincrement())
  patternName           String                  @map("pattern_name") // e.g., "SLRA Job Scam Ring"
  threatType            ThreatType              @map("threat_type")
  description           String                  @db.Text
  
  // Pattern identifiers
  knownContacts         Json                    @map("known_contacts") // Array of phone numbers, emails, handles
  commonPhrases         Json?                   @map("common_phrases") // Array of phrases used in scams
  targetedPlatforms     Json?                   @map("targeted_platforms") // [Facebook, WhatsApp, etc.]
  
  // Statistics
  reportCount           Int                     @default(0) @map("report_count")
  totalAmountLost       Float                   @default(0) @map("total_amount_lost")
  firstReported         DateTime                @map("first_reported")
  lastReported          DateTime                @map("last_reported")
  
  // Status
  isActive              Boolean                 @default(true) @map("is_active")
  publicWarningIssued   Boolean                 @default(false) @map("public_warning_issued")
  warningIssuedAt       DateTime?               @map("warning_issued_at")
  
  // Relations
  reports               CyberThreatReport[]
  
  @@map("threat_patterns")
  @@index([threatType])
  @@index([isActive])
}

// Official Government Information Database
model OfficialInformation {
  id                    Int                     @id @default(autoincrement())
  title                 String
  category              InformationCategory
  content               String                  @db.Text // The official information
  
  // Source details
  sourceMinistry        String                  @map("source_ministry") // e.g., "Ministry of Health"
  sourceUrl             String?                 @map("source_url") // Link to official announcement
  publishedDate         DateTime                @map("published_date")
  expiryDate            DateTime?               @map("expiry_date") // For time-sensitive info
  
  // Content management
  isActive              Boolean                 @default(true) @map("is_active")
  isPinned              Boolean                 @default(false) @map("is_pinned") // Featured/important info
  createdAt             DateTime                @default(now()) @map("created_at")
  updatedAt             DateTime                @updatedAt @map("updated_at")
  createdBy             String                  @map("created_by") // Admin who created this
  
  // Search and discovery
  keywords              Json?                   // Array of keywords for search
  viewCount             Int                     @default(0) @map("view_count")
  
  // Relations
  infoRequests          InformationRequest[]
  
  @@map("official_information")
  @@index([category])
  @@index([sourceMinistry])
  @@index([isActive])
  @@index([isPinned])
  @@index([publishedDate])
}

// Official Information Requests (Analytics)
model InformationRequest {
  id                    Int                     @id @default(autoincrement())
  topic                 String                  // What user asked about
  category              InformationCategory?
  ministry              String?                 // Relevant ministry
  
  // User information
  requesterPhone        String                  @map("requester_phone")
  user                  User?                   @relation(fields: [requesterPhone], references: [phoneE164])
  requestedAt           DateTime                @default(now()) @map("requested_at")
  
  // Response
  wasAnswered           Boolean                 @default(false) @map("was_answered")
  officialInfoId        Int?                    @map("official_info_id")
  officialInfo          OfficialInformation?    @relation(fields: [officialInfoId], references: [id])
  responseText          String?                 @db.Text @map("response_text")
  
  @@map("information_requests")
  @@index([requesterPhone])
  @@index([topic])
  @@index([category])
  @@index([requestedAt])
}

// User Feedback on Verifications
model UserFeedback {
  id                    Int                     @id @default(autoincrement())
  verificationId        Int                     @map("verification_id")
  verification          Verification            @relation(fields: [verificationId], references: [id], onDelete: Cascade)
  
  // Feedback details
  userPhone             String                  @map("user_phone")
  user                  User?                   @relation(fields: [userPhone], references: [phoneE164])
  isCorrect             Boolean?                @map("is_correct") // User agrees with verification?
  comment               String?                 @db.Text
  submittedAt           DateTime                @default(now()) @map("submitted_at")
  
  @@map("user_feedbacks")
  @@index([verificationId])
  @@index([userPhone])
}

// System Activity Logs (Audit Trail)
model ActivityLog {
  id                    Int                     @id @default(autoincrement())
  action                String                  // verify_information, report_threat, etc.
  userPhone             String                  @map("user_phone")
  details               Json?                   // Additional details about the action
  ipAddress             String?                 @map("ip_address")
  userAgent             String?                 @map("user_agent")
  timestamp             DateTime                @default(now())
  
  @@map("activity_logs")
  @@index([userPhone])
  @@index([action])
  @@index([timestamp])
}

// Public Awareness Campaigns
model PublicAwareness {
  id                    Int                     @id @default(autoincrement())
  title                 String
  type                  String                  // WARNING, ALERT, INFORMATION, EDUCATION
  content               String                  @db.Text
  threatType            ThreatType?             @map("threat_type") // If related to a threat
  
  // Targeting
  targetAudience        String?                 @map("target_audience") // ALL, YOUTH, ELDERLY, etc.
  priority              String                  // LOW, MEDIUM, HIGH, CRITICAL
  
  // Lifecycle
  publishedAt           DateTime                @map("published_at")
  expiresAt             DateTime?               @map("expires_at")
  isActive              Boolean                 @default(true) @map("is_active")
  
  // Distribution
  sentViaWhatsApp       Boolean                 @default(false) @map("sent_via_whatsapp")
  sentViaSMS            Boolean                 @default(false) @map("sent_via_sms")
  recipientCount        Int?                    @map("recipient_count")
  
  // Engagement
  viewCount             Int                     @default(0) @map("view_count")
  shareCount            Int                     @default(0) @map("share_count")
  
  @@map("public_awareness")
  @@index([isActive])
  @@index([priority])
  @@index([publishedAt])
}

// Analytics: Daily Statistics
model DailyStatistics {
  id                        Int       @id @default(autoincrement())
  date                      DateTime  @unique @db.Date
  
  // Verification stats
  totalVerifications        Int       @default(0) @map("total_verifications")
  verifiedTrue              Int       @default(0) @map("verified_true")
  verifiedFalse             Int       @default(0) @map("verified_false")
  verifiedPartial           Int       @default(0) @map("verified_partial")
  unverified                Int       @default(0) @map("unverified")
  
  // Threat stats
  totalThreats              Int       @default(0) @map("total_threats")
  urgentThreats             Int       @default(0) @map("urgent_threats")
  totalAmountLostDaily      Float     @default(0) @map("total_amount_lost_daily")
  
  // User stats
  activeUsers               Int       @default(0) @map("active_users")
  newUsers                  Int       @default(0) @map("new_users")
  
  // Performance
  avgResponseTimeMs         Int?      @map("avg_response_time_ms")
  
  @@map("daily_statistics")
  @@index([date])
}
